# corpusops.roles/services_backup_burp_vars variables role
## Documentation
- Collection of roles to manage burp servers & client:
    - [corpusops.roles/localsettings_burp](../services_backup_burp): install binary package
    - [corpusops.roles/burp_sign](../burp_sign): manage burp ca, sign certificates
    - [corpusops.roles/burp_fw](../burp_fw): restrict acces, via msiptables to burp
    - [corpusops.roles/burp_server_configuration](../burp_server_configuration): manage burp server
    - [corpusops.roles/burp_client_configuration](../burp_client_configuration/): configure a burp client configuration: client side
    - [corpusops.roles/burp_client_server](../burp_client_server): manage a burp client: server side configuration

##  Install a new client
- First be sure that the client can connect (``corpusops.roles/burp_fw`` role)
- Then define a resource for him
    - Generate it's certificate
    - Generate it's configuration files and install the burp binary
- The main playbook is [register](register/main.yml)<br/>
  It works with one host and one ansible group:
    - ``burp_server`` is a host
    - ``burp_clients`` is an ansible group of clients connecting to the former
      burp server and if you need to act on one host, make a group with this sole host.
- Workflow is as-is:
  - configure server
  - Allow clients IPs from server firewall
  - Generate client server configuration
  - Deploy & configure burp on the client
- Your inventory/variables Must expose a structure like this for server host:

    ```yaml
    _cops_burp_server:
        # any override of ./default.main.yml
        cops_burp_adminmail: "root <root@foo.com"
    ```
- Your inventory/variables Must expose a structure like this for clients:

    ```yaml
    # cname to auth to server and sign from burp_ca
    burp_cname: "{{ansible_fqdn}}"
    # password to use in exchange
    # (default: autogenerated onto burp_server)
    burp_password: null
    # ip to restrict (default public facable ipv4)
    burp_restrict_ips: []
    # backup profile to use (null to disable)
    burp_client_profile: baremetal
    # custom lines inside burp.conf
    burp_client_custom_lines: []
    # custom lines inside server/clientconfdir/client
    burp_client_conf_custom_lines: []
    # extra cops_burpclientserver registry vars
    burp_client_conf_extras: {}
    # extra cops_burpclient registry vars
    burp_client_extras: {}
    ```
- Call

    ```sh
    $COPS_ROOT/bin/ansible-playbook \
    corpusops.roles/burp_server_configuration/register/main.yml \
        -e "{burp_clients: clients_group, burp_server: server_host}" \
        [ --skip-tags burp_configure_server ]\
        [ --skip-tags burp_fw ]\
        [ --skip-tags burp_sign ]\
        [ --skip-tags burp_register_to_server ]\
        [ --skip-tags burp_deploy_client_certs ]\
        [ --skip-tags burp_configure_clients ]
    ```

- Exemple inventory

    ```yaml
    ---
    all:
      #hosts:
      #  one_host_with_custom_hosts.foo.net:
      #    burp_password: toto
      #    burp_client_ip: 1.2.3.4
      #    burp_client_server: foobar.net (default to server fqdn)
      #    burp_client_profile: overridenprofile
      #    burp_client_conf_restore_clients: ["foo.bar"]
      #    burp_client_conf_custom_lines: ["# def"]
      #    burp_client_custom_lines: ["# abc"]
      #    burp_client_use_profile: false
      #    burp_client_conf_extras: {}
      #    burp_client_extras: {}
      children:
        burp:
          children:
            burp_clients:
            burp_servers:
          vars:
            burp_cname: "{{ansible_fqdn}}"
        burp_clients:
          children:
            project_burp_clients:
          vars:
            burp_client: "{{inventory_hostname}}"
        burp_servers:
          children:
            project_burp_servers:
        project_burp_clients:
          hosts:
            project-ftp.foo.net:
            one_host_with_custom_hosts.foo.net:
        project_cur:
          hosts:
            project-ftp.foo.net:
        project_burp_servers:
          hosts:
            backupserver.foo.net:
    ```
