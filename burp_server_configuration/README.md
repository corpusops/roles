# corpusops.roles/services_backup_burp_vars variables role
## Documentation
- Collection of roles to manage burp servers & client:
    - [corpusops.roles/localsettings_burp](../services_backup_burp): install binary package
    - [corpusops.roles/burp_sign](../burp_sign): manage burp ca, sign certificates
    - [corpusops.roles/burp_fw](../burp_fw): restrict acces, via msiptables to burp
    - [corpusops.roles/burp_server_configuration](../burp_server_configuration): manage burp server
    - [corpusops.roles/burp_client_configuration](../burp_client_configuration/): manage a burp client : client side configuration
    - [corpusops.roles/burp_client_server](../burp_client_server): manage a burp client: server side configuration

##  Install a new client
- First be sure that the client can connect (``corpusops.roles/burp_fw`` role)
- Then define a resource for him
    - Generate it's certificate
    - Generate it's configuration files and install the burp binary
- The main playbook is [register](register/main.yml)<br/>
  It works with one host and one ansible group:
    - ``burp_server`` is a host
    - ``burp_clients`` is an ansible group of clients connecting to the former
      burp server and if you need to act on one host, make a group with this sole host.
- Workflow is as-is:
  - configure server
  - Allow clients IPs from server firewall
  - Generate client server configuration
  - Deploy & configure burp on the client

# base server configuration (burp_server_configuration & burp_sign roles)
- Your inventory/variables Must expose a structure like this for server host:

    ```yaml
    _cops_burp_server:
        # any override of ./defaults/main.yml
        cops_burp_adminmail: "root <root@foo.com"
    ```

# CA settings (burp_sign role configuration
- Your inventory/variables Must expose a structure like this for server host:

    ```yaml
    # any override of ../burp_sign/defaults/main.yml
    _cops_burp_sign: {}
    ```

# server firewall configuration (burp_fw role)
- Your inventory/variables Must expose some global variables:

    ```yaml
    # ip to restrict (default public facable ipv4)
    burp_restrict_ips: []
    # cname to auth to server and sign from burp_ca
    burp_cname: "{{ansible_fqdn}}"
    # password to use in exchange (default: autogenerated onto burp_server)
    burp_password: null
    ```

## Exemple inventory

```yaml
---
all:
  children:
    burp:
      children:
        burp_clients:
        burp_servers:
      vars:
        burp_cname: "{{ansible_fqdn}}"
    burp_clients:
      children:
        project_burp_clients:
      vars:
        burp_client: "{{inventory_hostname}}"
    burp_servers:
      children:
        project_burp_servers:
    project_burp_clients:
      hosts:
        project-ftp.foo.net:
        one_host_with_custom_hosts.foo.net:
    project_burp_servers:
      hosts:
        backupserver.foo.net:
```

## Setup, files & wrapper
- We setup 2 daemons, one for backuping, one for restoring
- Configurations are inside `/etc/burp-corpusops` (default)
- There are two shell wrappers to set the good configuration to call : `burp.sh` & `burp-restore.sh` inside that directory and they are linked to `/usr/local/bin.`

## Tune your clients configurations
 - You can use the following default variables that can be used as macros (profile and common conf that can be also reused).
        - ``cops_burpclientserver_backup_files``
        - ``cops_burpclientserver_profiles_baremetal``
        - ``cops_burpclientserver_profiles_vm``
        - ``cops_burpclientserver_common_exclude_re``
        - ``cops_burpclientserver_exclude_re``
    - ``cops_burpclientserver_vm_exclude_re``
    - ``cops_burpclientserver_baremetal_exclude_re``

### Define using a profile
You can use an existing profile, redefine only parts of a profile like `dedup group` or `backup dirs`  or the whole profile

By default variables are searched with a  name derived from ``inventory_hostname`` where `-*.` chars are **remmoved** (`foo-bar.net` â†’ `foobarnet`) and if we do not found, we fallback to default profiles.

Main concerned variables are (client is `foo-bar.net` ansible host):

- ``burpclientserver_profiles_<sanitizedID>``: for client's running profile
    - Redefining it, but reusing parts of the baremetal profile

        ```yaml
        # redefining
        burpclientserver_profiles_foo_bar_net: |-
          {{cops_burpclientserver_common_lines}}
          include=/Foo
        ```
    - Using an existing profile

        ```yaml
        # redefining
        burpclientserver_profiles_foo_bar_net: "{{cops_burpclientserver_profiles_baremetal}}"
        ```
    - define using a totally blank config

        ```yaml
        burpclientserver_profiles_foo_bar_net: |
          include=/Foo
        ```
- ``burpclientserver_dedupgroup_<sanitizedID>``: for client's dedup group

    ```yaml
    burpclientserver_dedupgroup_foo_bar_net: freebsd
    ```
- ``burpclientserver_backup_dirs_<sanitizedID>``: for client's directories for include

    ```yaml
    burpclientserver_backup_dirs_foo_bar_net: "{{cops_burpclientserver_default_backup_dirs+['/mnt/bm-foo']}}"
    ```
- ``burpclientserver_custom_lines_<sanitizedID>``: you can add custom lines this way

    ```yaml
    burpclientserver_custom_lines_foo_bar_net: |
      {{cops_burpclientserver_backup_files}}
      include=/Foo
      cross_filesystem=/Foo
    # or globally
    burpclientserver_custom_lines: |
      {{cops_burpclientserver_backup_files}}
      include=/Foo
      cross_filesystem=/Foo
    ```

## Registering a new client on the server, configure it and it's firewall, then deploy the client confs

```sh
$COPS_ROOT/bin/ansible-playbook \
$COPS_ROOT/roles/corpusops.roles/burp_server_configuration/register/main.yml \
  -e "{burp_client: [my.client], burp_server: server_host}" \
  # --skip-tags burp_server_install,burp_configure_server,burp_fw,burp_sign,burp_register_to_server,burp_deploy_client_certs,burp_configure_clients,burp_client_install
```


## Reconfigure the server itself and regenerate all client serverside configurations
- degraded mode:
    - you can add `get_burp_clients_facts: true` not to get clients ip to allow on firewall, uUnless you also reconfigure firewall (`burp_fw` tag)
    - `$server` can also be a group of burp servers to reconfigure or a list of servers.

```sh
server=server_host
$COPS_ROOT/bin/ansible-playbook --flush-cache -Dvvv -i $inv\
    $COPS_ROOT/roles/corpusops.roles/burp_server_configuration/configure_server/main.yml \
    -e "{burp_server: $server, cops_vars_debug: true, get_burp_clients_facts: false}" \
    --skip-tags burp_configure_server,burp_sign,burp_fw,burp_register_to_servere,burp_install
```

