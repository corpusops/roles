---
# generate and load any client password
- block:
  - include_role: {name: corpusops.roles/get_secret_variable}
    vars:
      _cops_get_secret_variable:
        name: "cops_burpclient_password_{{item}}"
        path: /etc/secrets/
    when: "hostvars.get(item, {}).get('burp_password', None) is none"
    with_items: "{{hostvars.localhost.aburp_clients}}"
  delegate_to: "{{hostvars.localhost.aburp_server}}"
- block:
  - include_jinja_vars:
      content: |
        ---
        {{ {'cops_burpclient_password_'+item: hostvars[item].burp_password}
           | to_json}}
    when: "hostvars.get(item, {}).get('burp_password', None) is not none"
    with_items: "{{hostvars.localhost.aburp_clients}}"
- block:
  - include_jinja_vars:
      content: |
        ---
        {% set res = {} %}
        {% for i in hostvars.localhost.aburp_clients %}
        {% set _ = res.update({
            i: vars['cops_burpclient_password_'+i]}) %}
        {% endfor %}
        {{ {'cops_burpclient_passwords': res} | to_json }}
  delegate_to: "{{hostvars.localhost.aburp_server}}"
