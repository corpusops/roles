---
- include_tasks: password.yml
- name: "Getting client - backup vars for {{inventory_hostname}}"
  include_jinja_vars:
   name: _cops_burpclient
   content: |-
      {%- set client = inventory_hostname %}
      {%- set hvars = hostvars[client] %}
      {%- set cname, profile = vars|copsfburp_get_cname_and_profile(hvars) %}
      {%- set server = hvars.get('burp_client_server',
              hostvars[hostvars.localhost.aburp_server]['ansible_fqdn']) %}
      {%- set data = {'cname': cname,
                      'server': server,
                      'ssl_peer_cn': server,
                      'password': vars['cops_burpclient_password_'+client],
                      'profile': profile,
                      'use_profile': hvars.get('burp_client_use_profile',
                                               profile is not none)}
      %}
      {%- set data = data|copsfburp_finish_settings('server', hvars) %}
      {{- data|to_json }}
- name: "Registering backup server conf for {{inventory_hostname}}"
  include_role: {name: corpusops.roles/burp_client_configuration}
- name: "Reset client - backup vars for {{inventory_hostname}}"
  include_jinja_vars:
   name: _cops_burpclient
   content: "{}"
