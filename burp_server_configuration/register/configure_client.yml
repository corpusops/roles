---
- include_tasks: password.yml
- name: "Getting client - backup vars for {{inventory_hostname}}"
  include_jinja_vars:
   name: _cops_burpclient
   content: |-
      {%- set client = inventory_hostname %}
      {%- set cdata = hostvars[client] %}
      {%- set cname = cdata.get('burp_cname', '') or cdata['inventory_hostname'] %}
      {%- set profile = ansible_virtualization_type in [
            'docker', 'lxc'] and 'vm' or 'baremetal' %}
      {%- set profile = cdata.get('burp_client_profile', profile) %}
      {%- set server = cdata.get('burp_client_server',
              hostvars[hostvars.localhost.aburp_server]['ansible_fqdn']) %}
      {%- set data = {'cname': cname,
                      'server': server,
                      'ssl_peer_cn': server,
                      'password': vars['cops_burpclient_password_'+client],
                      'profile': profile,
                      'use_profile': cdata.get('burp_client_use_profile',
                                               profile is not none)}
      %}
      {%- for k in ['restore_clients', 'custom_lines'] %}
      {%-   set val = cdata.get('burp_client_'+k, none) %}
      {%-   if val is not none %}
      {%-     set _ = data.update({k: val}) %}
      {%-   endif %}
      {%- endfor%}
      {%- set _ = data.update(cdata.get('burp_client_conf_extras', {})) %}
      {{- data|to_json }}
- name: "Regsitering backup server conf for {{inventory_hostname}}"
  include_role: {name: corpusops.roles/burp_client_configuration}
- name: "Reset client - backup vars for {{inventory_hostname}}"
  include_jinja_vars:
   name: _cops_burpclient
   content: "{}"
