---
{% set prefix = 'corpusops_services_db_postgis_' %}
{% set pgprefix = 'corpusops_services_db_postgresql_' %}
{% set flavors = ['ubuntu', 'debian', 'redhat', 'default'] %}
{% set knobs = ['files', 'filescopy', 'configs', 'packages', 'services',
                ] %}
{% set computed_defaults = ['packages'] %}
{% set lowered = [] %}
{% set lowered = [] %}
{% set sub_namespaced = {'pg_conf': {}, 'settings': {}} %}
{% set namespaced = {'pg_conf': {}, 'settings': {}} %}
{% set subos_append = {} %}

{% set namespaced, vars = vars
   | copsf_scoped_registry(
        prefix, do_resolve=False,
        knobs=knobs, subos_append=subos_append,
        lowered=lowered, computed_defaults=computed_defaults,
        flavors=flavors, namespaced=namespaced, sub_namespaced=sub_namespaced)
%}

{% if vars['ansible_distribution'] in ['Ubuntu'] and  (vars['ansible_distribution_version'] | copsf_looseversion >= '16.04') %}
{% set _ = namespaced['packages'].append('liblwgeom-dev') %}
{% endif %}

{% if not namespaced['version'] %}
{% if   (vars[pgprefix+'version'] | copsf_looseversion) >= ('9.6'|copsf_looseversion)  %}
{% set _ = namespaced.update({'version': '2.3'}) %}
{% elif (vars[pgprefix+'version'] | copsf_looseversion) >= ('9.4|copsf_looseversion')  %}
{% set _ = namespaced.update({'version': '2.2'}) %}
{% else %}
{% set _ = namespaced.update({'version': '2.3'}) %}
{% endif %}
{% endif %}

{{  ((namespaced | copsf_registry_to_vars(vars, prefix))[0]
    | copsf_format_val(vars)
    | copsf_registry_to_vars(vars, prefix))[0]
    | to_json }}
