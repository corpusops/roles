---
- debug:
    msg: |
      {% set display = {
        'lxc_auto_start': lxc_auto_start,
        'lxc_container_name': lxc_container_name,
        'lxc_from_container': lxc_from_container
      } %}{{display | to_json}}
  tags: corpusops_lxc_create,corpusops_lxc_create_vars
- name: lxc create test
  shell: |-
    lxc-ls -P "{{lxc_path}}" --fancy |tail -n +2|awk '{print $1}'|\
    egrep -q "^{{lxc_container_name}}$";echo $?
  register: corpusops_lxc_create_lxc_test
  tags: corpusops_lxc_create,corpusops_lxc_create_lxc
- include_tasks: manual_lxc_conf.yml
  when: 'corpusops_lxc_create_lxc_test.stdout == "0"'
  tags: corpusops_lxc_create
- include_tasks: fstab.yml
  tags: corpusops_lxc_create
  when: 'corpusops_lxc_create_lxc_test.stdout == "0"'
- include_tasks: from_template.yml
  when: 'lxc_from_container == ""'
  tags: corpusops_lxc_create,corpusops_lxc_create_lxc_bare
- include_tasks: from_image.yml
  when: 'lxc_from_container != ""'
  tags: corpusops_lxc_create,corpusops_lxc_create_lxc_bare
- include_tasks: fstab.yml
  tags: corpusops_lxc_create,corpusops_lxc_create_lxc_bare
- include_tasks: manual_lxc_conf.yml
  tags: corpusops_lxc_create,corpusops_lxc_create_lxc_bare
- name: lxc mgmt dirs
  file:
    path: "{{item}}"
    mode: "0755"
    state: directory
  tags: corpusops_lxc_create,corpusops_lxc_create_dirs
  with_items:
    - "{{lxc_path}}/{{lxc_container_name}}"
    - "{{lxc_path}}/{{lxc_container_name}}/bin"
- name: lxc mgmt scripts
  copy:
    src: '../templates/{{item}}'
    dest: "{{lxc_path}}/{{lxc_container_name}}/{{item}}"
    mode: "0755"
    force: true
  tags: corpusops_lxc_create,corpusops_lxc_create_scripts
  with_items:
    - bin/cops_reset-host.py
    - bin/cops_shell_common
    - bin/cops_pkgmgr_install.sh
    - bin/cops_lxc_init.sh
    - cops_lxc_prereqs.sh
    - cops_lxc_manage.sh
- name: lxc config (from template script)
  template:
    src: "../templates/lxc.conf"
    dest: "{{lxc_path}}/{{lxc_container_name}}/config"
    mode: "0600"
  register: corpusops_lxc_create_config
  tags: corpusops_lxc_create,corpusops_lxc_create_lxc
- name: "RestartContainer{{lxc_container_name}}"
  shell: "{{lxc_path}}/{{lxc_container_name}}/cops_lxc_manage.sh restart"
  when: "corpusops_lxc_create_config.changed"
  tags: corpusops_lxc_create,corpusops_lxc_create_prereq
- name: "StartContainer{{lxc_container_name}}"
  shell: "{{lxc_path}}/{{lxc_container_name}}/cops_lxc_manage.sh start"
  tags: corpusops_lxc_create,corpusops_lxc_create_prereq
- name: lxc reset force
  shell: |
    lxc-attach -P "{{lxc_path}}" -n {{lxc_container_name}} -- \
      rm -f /etc/lxc_reset_done
  tags: corpusops_lxc_create,corpusops_lxc_create_prereq
  when: "corpusops_lxc_create_lxc_test['stdout'] == '1'"
- name: lxc prereq
  shell: "{{lxc_path}}/{{lxc_container_name}}/cops_lxc_prereqs.sh"
  tags: corpusops_lxc_create,corpusops_lxc_create_prereq
