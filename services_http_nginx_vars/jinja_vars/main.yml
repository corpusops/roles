---
{% set prefix = 'corpusops_services_http_nginx_' %}
{% set flavors = ['ubuntu', 'debian', 'redhat', 'default'] %}
{% set knobs = ['files', 'filescopy', 'configs', 'packages', 'services',
                'repo_keys', 'repo_keys_url', 'repo',
                ] %}
{% set computed_defaults = ['repo'] %}
{% set lowered = ['repo'] %}
{% set sub_namespaced = {'settings': {}} %}
{% set namespaced = {'settings': {}} %}
{% set subos_append = {} %}

{% if ansible_system == 'Linux' %}
{%  set _ = vars.update({prefix+'epoll': True}) %}
{% endif %}

{% if ansible_virtualization_type.startswith(('lxc', 'docker')) %}
{%  set _ = vars.update({prefix+'is_reverse_proxied': True}) %}
{% endif %}

{% if ansible_virtualization_type.startswith(('virtualbox',)) %}
{%  set _ = vars.update({prefix+'sendfile': False}) %}
{% endif %}

{% if vars.get('ansible_default_ipv4', None) %}
{%  set gw = vars.ansible_default_ipv4.get('gateway', None) %}
{%  if (vars[prefix+'is_reverse_proxied'] and
        gw and
        gw not in vars[prefix+'reverse_proxy_addresses']) %}
{%    set _ = vars[prefix+'reverse_proxy_addresses'].append(gw) %}
{%  endif %}
{% endif %}
{% set namespaced, vars = vars
   | copsf_registry(
        prefix,
        knobs=knobs, subos_append=subos_append,
        lowered=lowered, computed_defaults=computed_defaults,
        flavors=flavors, namespaced=namespaced, sub_namespaced=sub_namespaced)
%}
{{ (namespaced | copsf_registry_to_vars(vars, prefix))[0] | to_json }}
