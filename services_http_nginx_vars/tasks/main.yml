---
- include_jinja_vars:
    content: |-
      ---
      {% set prefix = 'corpusops_services_http_nginx_' %}
      {%- if ansible_system == 'Linux' %}
      {%-  set _ = vars.update({prefix+'epoll': True}) %}
      {%- endif %}
      {%- if ansible_virtualization_type.startswith(('lxc', 'docker')) %}
      {%-  set _ = vars.update({prefix+'is_reverse_proxied': True}) %}
      {%- endif %}
      {%- if ansible_virtualization_type.startswith(('virtualbox',)) %}
      {%-  set _ = vars.update({prefix+'sendfile': False}) %}
      {%- endif %}
      {%- if vars.get('ansible_default_ipv4', None) %}
      {%-  set gw = vars.ansible_default_ipv4.get('gateway', None) %}
      {%-  if (vars[prefix+'is_reverse_proxied'] and
              gw and
              gw not in vars[prefix+'reverse_proxy_addresses']) %}
      {%-    set _ = vars[prefix+'reverse_proxy_addresses'].append(gw) %}
      {%-  endif %}
      {%- endif %}
      {%- set snamespaced, vars = vars | copsf_registry(prefix) %}
      {%- set namespaced = snamespaced[prefix+'vars'] %}
      {{- (snamespaced[prefix+'vars']
           | copsf_registry_to_vars(vars, prefix, global_scope=True)
             )[0] | to_json}}
  tags: [corpusops_vars, corpusops_services_http_nginx_vars]
  no_log: "{{not (cops_vars_debug|default(false))}}"
