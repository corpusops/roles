---
# Generate passwords on remote box if not found in registry
- include_role: {name: corpusops.roles/get_secret_variable}
  vars:
    _cops_get_secret_variable:
      name: "corpusops_services_db_mysql_{{item}}"
      path: /etc/secrets
  loop: "{{corpusops_services_db_mysql_secret_variables|flatten(levels=1)}}"
- include_jinja_vars:
    content: |-
      ---
      {% set prefix = 'corpusops_services_db_mysql_' %}
      {% set snamespaced, vars = vars
          | copsf_registry(prefix) %}
      {% set data, vars = snamespaced[prefix+'vars']
          | copsf_mysql(vars, prefix)%}
      {{ (data
         | copsf_registry_to_vars(
             vars, prefix, global_scope=True)
         )[0]
         | to_json}}
  tags: [corpusops_vars, corpusops_services_db_mysql_vars]
  no_log: "{{not (cops_vars_debug|default(false))}}"
- include_tasks: version.yml
