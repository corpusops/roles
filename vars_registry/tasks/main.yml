---
# load default variables, first pass, load not resolved values
- include_jinja_vars:
    name: __GLOBAL__
    content: |
      ---
      {% set n = cops_vars_registry_name %}
      {% set p = cops_vars_registry_target %}
      {% set prefix = cops_vars_registry_prefix %}
      {% set o = cops_vars_registry_overrides %}
      {% set res = {n: vars.get(p, {}) | copsf_deepcopy} %}
      {% set overrides = vars.get(o, {}) | copsf_deepcopy %}
      {% set _ = res[n]|copsf_dictupdate(overrides) %}
      {#
      Record registry & overrides back to first level, flattened variables
          {foo: {a: o, bar: 1}, foo_overrides: {bar, 2}}
          => {foo_bar: 2, foo_a: o}
      #}
      {# Set back to global values each subelement
          foo_bar: {1:2} => foo_bar_1: 2 #}
      {% for var, val in res[n].items() %}
      {%  set _ = res|copsf_dictupdate({'{0}{1}'.format(prefix, var): val}) %}
      {% endfor %}
      {# Construct registry variable
          foo_bar_1, => foo_bar_vars: {1: 2}#}
      {% for var, val in vars.items() %}
      {%  if var.startswith(prefix) and var not in [prefix, n, p, o] %}
      {%    set svar = prefix.join(var.split(prefix)[1:]) %}
      {%    set val = res.get(var, res[n].get(svar, val)) %}
      {%    set _ = res[n]|copsf_dictupdate({svar: val}) %}
      {%  endif %}
      {% endfor %}
      {{ res | to_json }}
