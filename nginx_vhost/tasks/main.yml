---
# load default variables, first pass, load not resolved values
- include_role: {name: corpusops.roles/vars_registry}
  vars:
    cops_vars_registry_target: corpusops_nginx_vhost
  tags: [corpusops_vars, corpusops_nginx_vhost, corpusops_nginx_vhost_vars]
# make some stuff to DRY templates
- name: "nginx_vhost - compute - 1"
  tags: [corpusops_vars, corpusops_nginx_vhost, corpusops_nginx_vhost_vars]
  include_jinja_vars:
    name: __GLOBAL__
    content: |
      ---
      {% set n = 'corpusops_nginx_vhost_vars' %}
      {% set res = vars[n] %}
      {% set restarthanders = res.rhandlers %}
      # force nginx reload/restart via vhost variables
      {% for i in ['restart', 'reload'] %}
      {%   if res['force_'+i] not in restarthanders %}
      {%     set _ = restarthanders.append(
               i+'_nginx_via_corpusops_nginx_vhost') %}
      {%   endif %}
      {% endfor %}
      {% set _ = res.update({'small_name': res.small_name.replace(
            '.', '_').replace('-', '_').replace('*', 'star')}) %}
      {% set res = {n: res} %}
      {{ (res | copsf_registry_to_vars(vars, n))[0] | to_json }}
  no_log: "{{not (cops_vars_debug|default(false))}}"
# do the real stuff
- name: gen vhost
  include_tasks: run.yml
  tags: [corpusops_nginx_vhost, corpusops_nginx_vhost_gen]
