---
# load default variables, first pass, load not resolved values
- debug:
    msg: |
      {% set res = {'prefix': 'corpusops_nginx_vhost_'} %}
      {% for var, val in vars.items() %}
      {%  if (var != res.prefix and
              var.startswith(res.prefix) and
              not var.startswith(res.prefix+'vars')) %}
      {%   set _ = res.update({var: val}) %}
      {%  endif %}
      {% endfor %}
      {{ res | to_json }}
  register: "corpusops_nginx_vhost_vars_pre"
  tags: [corpusops_vars, corpusops_nginx_vhost, corpusops_nginx_vhost_vars]
# force variables to be resolved
- debug:
    msg: "{{corpusops_nginx_vhost_vars_pre.msg}}"
  register: "corpusops_nginx_vhost_vars_pre"
  tags: [corpusops_vars, corpusops_nginx_vhost, corpusops_nginx_vhost_vars]
# make computations when variable are resolved and store them in a namespace
- name: nginx_vhost - compute - 1
  tags: [corpusops_vars, corpusops_nginx_vhost, corpusops_nginx_vhost_vars]
  include_jinja_vars:
    name: "corpusops_nginx_vhost_vars"
    content: |
             ---
             {% set res = {} %}
             {% for var, val in corpusops_nginx_vhost_vars_pre.msg.items() %}
             {%   if var != 'prefix' %}
             {%     set svar = var.split(corpusops_nginx_vhost_vars_pre.msg.prefix, 1)[1] %}
             {%   else %}
             {%     set svar = 'vars_prefix'%}
             {%   endif %}
             {%   set _ = res.update({svar: val}) %}
             {% endfor %}
             {{ res | to_json }}
# make some stuff to DRY templates
- name: nginx_vhost - compute - 1
  tags: [corpusops_vars, corpusops_nginx_vhost, corpusops_nginx_vhost_vars]
  include_jinja_vars:
    name: "corpusops_nginx_vhost_vars"
    content: |
             ---
             {% set res = corpusops_nginx_vhost_vars %}
             {% set restarthanders = [] %}
             {% if res.force_reload %}
             {% set _ = restarthanders.append('reload_nginx_via_corpusops_nginx_vhost') %}
             {% endif %}
             {% if res.force_restart %}
             {% set _ = restarthanders.append('restart_nginx_via_corpusops_nginx_vhost') %}
             {% endif %}
             {% set _ = res.rhandlers.extend(restarthanders) %}
             {{ res | to_json }}
# do the real stuff
- name: gen vhost
  include: run.yml
  tags: [corpusops_nginx_vhost, corpusops_nginx_vhost_gen]
