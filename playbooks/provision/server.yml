---
- hosts: all
  roles:
    - role: corpusops.humanlog
    - role: corpusops.include_jinja_vars
    - role: corpusops.vars
- hosts: all
  tasks:
    - name: SETUP
      include_jinja_vars:
        content: |
          ---
          {% set vt = corpusops_vars.vt %}
          {% set is_docker    = corpusops_vars.is_docker %}
          {% set is_lxc       = corpusops_vars.is_lxc %}
          {% set is_container = corpusops_vars.is_container %}
          {% set corpusops_localsettings_git = corpusops_localsettings_git
                | default(True) %}
          {% set corpusops_localsettings_screen = corpusops_localsettings_screen
                | default(True) %}
          {% set corpusops_localsettings_pkgmgr = corpusops_localsettings_pkgmgr
                | default(True) %}
          {% set corpusops_localsettings_locales = corpusops_localsettings_locales
                | default(True) %}
          {% set corpusops_localsettings_basepkgs = corpusops_localsettings_basepkgs
                | default(True) %}
          {% set corpusops_localsettings_dns_servers = corpusops_localsettings_dns_servers
                | default([]) %}
          {% set corpusops_localsettings_dns_search = corpusops_localsettings_dns_search
                | default([]) %}
          {% set corpusops_localsettings_vim = corpusops_localsettings_vim
                | default(True) %}
          {% set corpusops_localsettings_editor = corpusops_localsettings_editor
                | default(not is_docker) %}
          {% set corpusops_localsettings_sudo = corpusops_localsettings_sudo
                | default(True) %}
          {% set corpusops_localsettings_sysctls = corpusops_localsettings_sysctls
                | default(not is_docker) %}
          {% set corpusops_localsettings_etckeeper = not is_docker %}
          {% set corpusops_localsettings_apparmor = corpusops_localsettings_apparmor
              | default(ansible_lsb.id == 'Ubuntu' and not is_container)
              | ternary(True, False) %}
          {% set corpusops_services_base_ssh_server = corpusops_services_base_ssh_server
              | default(True) %}
          {% set corpusops_services_base_ntp = corpusops_services_base_ntp
              | default(not is_container) %}
          {% set corpusops_localsettings_autoupgrades = corpusops_localsettings_autoupgrades
              | default(corpusops_vars.security) %}
          {% set corpusops_services_firewall_fail2ban = corpusops_services_firewall_fail2ban
              | default(corpusops_services_base_ssh_server and corpusops_vars.security)
              | ternary(True, False) %}
          {% set corpusops_localsettings_golang = corpusops_localsettings_golang
                | default(False) %}
          {% set corpusops_localsettings_jdk = corpusops_localsettings_jdk
                | default(False) %}
          {% set corpusops_services_base_sshd = corpusops_services_base_sshd
                | default(not is_docker) %}
          {% set corpusops_services_virt_docker = corpusops_services_virt_docker
                | default(not is_docker) %}
          {% set corpusops_services_base_cron = corpusops_services_base_cron
                | default(True) %}
          {% set corpusops_localsettings_ssh = corpusops_localsettings_ssh
                | default(True) %}
          {% set corpusops_localsettings_profile = corpusops_localsettings_profile
                | default(True) %}
          {% set corpusops_localsettings_nscd = not is_docker %}
          {% set corpusops_localsettings_dns = (
                corpusops_localsettings_dns_servers or
                corpusops_localsettings_dns_search) | length > 0 %}
          corpusops_localsettings_apparmor: {{ corpusops_localsettings_apparmor }}
          corpusops_localsettings_autoupgrades: {{ corpusops_localsettings_autoupgrades }}
          corpusops_localsettings_basepkgs: {{ corpusops_localsettings_basepkgs }}
          corpusops_localsettings_dns: {{ corpusops_localsettings_dns }}
          corpusops_localsettings_vim: {{ corpusops_localsettings_vim }}
          corpusops_localsettings_editor: {{ corpusops_localsettings_editor }}
          corpusops_localsettings_etckeeper: {{ corpusops_localsettings_etckeeper }}
          corpusops_localsettings_git: {{ corpusops_localsettings_git }}
          corpusops_localsettings_golang: {{ corpusops_localsettings_golang }}
          corpusops_localsettings_jdk: {{ corpusops_localsettings_jdk }}
          corpusops_localsettings_locales: {{ corpusops_localsettings_locales }}
          corpusops_localsettings_nscd: {{ corpusops_localsettings_nscd }}
          corpusops_localsettings_pkgmgr: {{ corpusops_localsettings_pkgmgr }}
          corpusops_localsettings_profile: {{ corpusops_localsettings_profile }}
          corpusops_localsettings_screen: {{ corpusops_localsettings_screen }}
          corpusops_localsettings_ssh: {{ corpusops_localsettings_ssh }}
          corpusops_localsettings_sudo: {{ corpusops_localsettings_sudo }}
          corpusops_localsettings_sysctls: {{ corpusops_localsettings_sysctls }}
          corpusops_services_base_cron: {{ corpusops_services_base_cron }}
          corpusops_services_base_ntp: {{ corpusops_services_base_ntp }}
          corpusops_services_base_sshd: {{ corpusops_services_base_sshd }}
          corpusops_services_firewall_fail2ban: {{ corpusops_services_firewall_fail2ban }}
          corpusops_services_virt_docker: {{ corpusops_services_virt_docker }}
      tags: corpusops_vars,corpusops_vars_core,corpusops_vars_provision
- hosts: all
  roles:
    - role: corpusops.localsettings_dns
    - role: corpusops.localsettings_sysctls
    - role: corpusops.localsettings_pkgmgr
    - role: corpusops.localsettings_locales
    - role: corpusops.localsettings_autoupgrades
    - role: corpusops.localsettings_basepkgs
    - role: corpusops.localsettings_profile
    - role: corpusops.localsettings_apparmor
    - role: corpusops.localsettings_editor
    - role: corpusops.localsettings_etckeeper
    - role: corpusops.localsettings_git
    - role: corpusops.localsettings_golang
    - role: corpusops.localsettings_jdk
    - role: corpusops.localsettings_nscd
    - role: corpusops.localsettings_screen
    - role: corpusops.localsettings_ssh
    - role: corpusops.localsettings_sudo
    - role: corpusops.services_base_ntp
    - role: corpusops.services_base_sshd
    - role: corpusops.services_base_cron
    - role: corpusops.services_virt_docker

